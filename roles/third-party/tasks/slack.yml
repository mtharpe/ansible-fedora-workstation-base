---
- name: Check if Slack is already installed
  ansible.builtin.command:
    cmd: rpm -q slack
  register: slack_installed
  changed_when: false
  failed_when: false
  tags: [third_party, slack]

- name: Download Slack RPM via curl
  ansible.builtin.shell: |
    curl -fSL -A "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
      "https://downloads.slack-edge.com/desktop-releases/linux/x64/4.46.101/slack-4.46.101-0.1.el8.x86_64.rpm" -o /tmp/slack-latest.rpm
  args:
    executable: /bin/bash
  when: slack_installed.rc != 0
  tags: [third_party, slack]

- name: Verify downloaded file is an RPM
  ansible.builtin.command:
    cmd: file -b /tmp/slack-latest.rpm
  register: slack_rpm_file
  changed_when: false
  failed_when: "'RPM' not in slack_rpm_file.stdout"
  vars:
    ansible_shell_executable: /bin/bash
  when: slack_installed.rc != 0
  tags: [third_party, slack]

- name: Show downloaded file type when verification failed
  ansible.builtin.debug:
    msg: "Downloaded file /tmp/slack-latest.rpm type: {{ slack_rpm_file.stdout }}"
  when: slack_installed.rc != 0 and 'RPM' not in slack_rpm_file.stdout
  tags: [third_party, slack]

- name: Install Slack (latest RPM)
  ansible.builtin.dnf:
    name: /tmp/slack-latest.rpm
    disable_gpg_check: true
    state: present
  become: true
  when: slack_installed.rc != 0
  tags: [third_party, slack]
