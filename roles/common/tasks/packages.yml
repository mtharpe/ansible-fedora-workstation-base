---
# Install extra packages
- name: Install base packages
  ansible.builtin.dnf:
    name:
      - 1password
      - direnv
      - fail2ban
      - ansible
      - ansible-lint
      - arpwatch
      - autoconf
      - autofs
      - automake
      - cmake
      - firewalld
      - firewalld-filesystem
      - golang
      - golang-godoc
      - golang-gotype
      - gh
      - htop
      - fastfetch
      - iotop
      - jq
      - lshw
      - lsscsi
      - nfs-utils
      - ngrep
      - nmap
      - nmon
      - npm
      - speedtest-cli
      - sysstat
      - tmux
      - transmission
      - neovim
      - terraform
      - vault
      - consul
      - nomad
      - packer
      - psutils
      - python3-psutil
      - python3-pip
      - python3-termcolor
      - unzip
      - alacritty
      - vlc
      - util-linux
      - nextcloud-client
      - gnome-extensions-app
    state: present

# Swap ffmpeg-free with full ffmpeg
- name: Swap ffmpeg-free with ffmpeg
  ansible.builtin.command:
    cmd: dnf swap 'ffmpeg-free' 'ffmpeg' --allowerasing -y
  become: true
  register: ffmpeg_swap_result
  changed_when: ffmpeg_swap_result.rc == 0
  failed_when: ffmpeg_swap_result.rc not in [0]

# Upgrade multimedia group with specific options
- name: Upgrade @multimedia without weak deps and exclude PackageKit-gstreamer-plugin
  ansible.builtin.command:
    cmd: dnf upgrade @multimedia --setopt=install_weak_deps=False --exclude=PackageKit-gstreamer-plugin -y
  become: true
  register: multimedia_upgrade_result
  changed_when: multimedia_upgrade_result.rc == 0
  failed_when: multimedia_upgrade_result.rc not in [0]

# Install ffmpeg libraries and VA-API utilities
- name: Install ffmpeg-libs and VA-API packages
  ansible.builtin.dnf:
    name:
      - ffmpeg-libs
      - libva
      - libva-utils
    state: present
  become: true

# Install OpenH264 and related plugins
- name: Install OpenH264 codecs and plugins
  ansible.builtin.dnf:
    name:
      - openh264
      - gstreamer1-plugin-openh264
      - mozilla-openh264
    state: present
  become: true

# Enable fedora-cisco-openh264 repository
- name: Enable fedora-cisco-openh264 repository via config-manager
  ansible.builtin.command:
    cmd: dnf config-manager setopt fedora-cisco-openh264.enabled=1
  become: true
  register: h264_repo_enable
  changed_when: h264_repo_enable.rc == 0
  failed_when: h264_repo_enable.rc not in [0]

# Install molecule for testing
- name: Install molecule via pip
  ansible.builtin.pip:
    name: molecule
    state: present

# Install molecule-podman driver for Molecule
- name: Install molecule-podman driver via pip
  ansible.builtin.pip:
    name: molecule-podman
    state: present

# Install podman only if docker is not requested
- name: Install podman if docker is not enabled
  ansible.builtin.dnf:
    name: podman
    state: present
  when: not install_docker | default(false)

# Install extra fonts
- name: Install extra fonts
  ansible.builtin.dnf:
    name:
      - adobe-source-code-pro-fonts
      - dejavu-sans-fonts
      - dejavu-sans-mono-fonts
      - dejavu-serif-fonts
      - gnu-free-fonts-common
      - gnu-free-mono-fonts
      - gnu-free-sans-fonts
      - gnu-free-serif-fonts
      - levien-inconsolata-fonts
      - liberation-fonts-common
      - liberation-mono-fonts
      - liberation-sans-fonts
      - liberation-serif-fonts
      - msimonson-anonymouspro-fonts
      - overpass-fonts
      - terminus-fonts
    state: present

# Optionally install a Nerd Font (FiraCode) for icons (starship, prompts)
- name: Check if FiraCode Nerd Font is already installed
  ansible.builtin.command:
    cmd: fc-list | grep -i "Fira Code"
  register: firacode_fonts
  failed_when: false
  changed_when: false
  when: install_nerd_font | default(false)

- name: Download FiraCode Nerd Font zip
  ansible.builtin.get_url:
    url: "https://github.com/ryanoasis/nerd-fonts/releases/latest/download/FiraCode.zip"
    dest: /tmp/FiraCode.zip
    mode: '0644'
    force: yes
  when:
    - install_nerd_font | default(false)
    - firacode_fonts.rc != 0

- name: Create nerd fonts directory
  ansible.builtin.file:
    path: /usr/local/share/fonts/nerdfonts
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: true
  when: install_nerd_font | default(false)

- name: Unarchive FiraCode Nerd Font
  ansible.builtin.unarchive:
    src: /tmp/FiraCode.zip
    dest: /usr/local/share/fonts/nerdfonts
    remote_src: yes
  become: true
  when: install_nerd_font | default(false)

- name: Refresh font cache
  ansible.builtin.command:
    cmd: fc-cache -f -v
  become: true
  when: install_nerd_font | default(false)

# Uninstall unwanted apps
- name: Uninstall junk apps
  ansible.builtin.dnf:
    name:
      - firefox
      - gnome-calendar
      - gnome-contacts
      - gnome-maps
      - rhythmbox
      - totem
      - gnome-tour
      - gnome-abrt
      - gnome-logs
    allowerasing: true
    state: absent
